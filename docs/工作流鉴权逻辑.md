# 工作流鉴权逻辑说明

本文件梳理了 `auth_manager.py` 中的工作流鉴权核心逻辑，便于开发者理解和维护。

---

## 1. 用户授权数据的获取与解析

- **数据来源**：
  - 通过 `get_user_custom_data()` 获取，通常来自 Authing 的自定义字段（UDF）。
- **解析方式**：
  - `_parse_user_data` 方法负责解析 UDF 数据，确保其为标准 JSON 格式。
  - 解析后提取两个核心字段：
    - `packages`：用户拥有的包（每个包有 id、type、expired_at）
    - `workflows`：用户直接授权的工作流（每个工作流有 id、type、expired_at）

> **说明：**
> - 2024年6月起，已移除 `basic_access` 相关逻辑，所有鉴权仅依赖包授权和工作流直接授权。
> - `monthly` 类型已合并为 `temp`，所有基于时间的授权统一为 `temp` 类型。

---

## 2. 包配置的加载

- **包配置文件**：
  - 由 `package_config_path` 指定（如 `config/package.json`），定义了每个包包含哪些工作流。
- **加载逻辑**：
  - `_load_package_config` 方法会尝试多种路径加载包配置，确保能找到正确的配置文件。

---

## 3. 鉴权核心逻辑

### 3.1 授权有效性判断

- **方法**：`_is_authorization_valid(auth_type, expired_at)`
- **逻辑**：
  - 类型为 `lifetime` 时，永不过期，直接返回 True。
  - 类型为 `temp` 时（包括原 `monthly`、`yearly`），判断 `expired_at` 是否晚于当前时间。
  - 支持多种时间格式的解析。

### 3.2 获取包内工作流

- **方法**：`_get_package_workflows(package_id)`
- **逻辑**：根据包 ID，从包配置文件中查找该包包含的所有工作流 ID。

### 3.3 获取所有授权工作流

- **方法**：`get_authorized_workflows()`
- **流程**：
  1. 遍历用户拥有的所有包，判断包授权是否有效，有效则将包内所有工作流加入授权列表。
  2. 遍历用户直接授权的工作流，判断授权是否有效，有效则加入授权列表。
     - 如果同一个工作流既有包授权又有直接授权，优先级为：直接授权为 `lifetime` 时覆盖包授权。
  3. 返回所有被授权的工作流及其授权信息（来源、类型、过期时间等）。

---

## 4. 对外接口

- `get_workflow_list()`：返回所有用户可访问的工作流 ID 列表。
- `is_workflow_authorized(workflow_id)`：判断用户是否有权限访问指定工作流。
- `get_workflow_expiry(workflow_id)`：获取指定工作流的过期时间（如为永久授权则返回 None）。

---

## 5. 典型调用流程

1. 初始化 `AuthManager`，自动加载用户数据和包配置。
2. 通过 `get_authorized_workflows()` 获取所有有权访问的工作流及其详细授权信息。
3. 通过 `is_workflow_authorized(workflow_id)` 判断某个工作流是否有权限。
4. 通过 `get_workflow_expiry(workflow_id)` 获取某个工作流的授权到期时间。

---

## 6. 其他说明

- 支持直接从 Authing UDF 数据创建实例（`from_authing_udf` 静态方法）。
- 支持保存和加载用户 UDF 数据到本地文件，便于调试和持久化。
- 日志详细，便于排查问题。

---

## 总结

本模块的工作流鉴权逻辑为：
- 仅判断包授权和直接授权的有效性，合并所有有效的工作流授权；
- 所有基于时间的授权统一为 `temp` 类型（包括原 `monthly`、`yearly`）；
- 提供多种接口供外部查询用户对工作流的访问权限和授权详情。

如需具体某一段代码的详细解释，可查阅源码或联系维护者。 